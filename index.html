<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />

    <title>premy</title>
  </head>

  <body>
    <button id="open-button">Open</button>
    <premy-dialog id="dialog"></premy-dialog>

    <script type="module">
      import "./dist/index.js";

      const dialog = document.querySelector("#dialog");
      const openButton = document.querySelector("#open-button");

      dialog.addEventListener("premyClose", (event) => {
        dialog.removeAttribute("open");
      });

      openButton.addEventListener("click", (event) => {
        dialog.setAttribute("open", "");
      });

      const premyDBOpenRequest = indexedDB.open("premy", 1);

      premyDBOpenRequest.onsuccess = () => {
        const premyDB = premyDBOpenRequest.result;

        const transaction = premyDB.transaction(["etc"], "readonly");
        const etcStore = transaction.objectStore("etc");
        const historyGetRequest = etcStore.get("history");
        historyGetRequest.onsuccess = () => {
          const history = historyGetRequest.result;
          if (!history) {
            return;
          }
          dialog.setAttribute("history", JSON.stringify(history));
        };

        dialog.addEventListener("premyHistoryChange", (event) => {
          const transaction = premyDB.transaction(["etc"], "readwrite");
          const etcStore = transaction.objectStore("etc");
          etcStore.put(event.detail.history, "history");
        });
      };

      premyDBOpenRequest.onupgradeneeded = (event) => {
        const premyDB = premyDBOpenRequest.result;
        let version = event.oldVersion;

        if (version === 0) {
          const etcStore = premyDB.createObjectStore("etc");
          const image = localStorage.getItem("premy-image");
          if (image) {
            etcStore.put([image], "history");
          }
          localStorage.removeItem("premy-image");

          version++;
        }
      };
    </script>
  </body>
</html>
